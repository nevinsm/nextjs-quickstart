# AI Integration Scaffold

This project includes a safe, provider-agnostic API scaffold at `src/app/api/ai/route.ts`.

## Endpoint

- `POST /api/ai`

## What this route does today

- Validates request bodies with `zod`
- Enforces Supabase-backed rate limiting (`checkRateLimitSupabase`)
- Returns a controlled fallback response instead of calling an AI SDK
- Handles malformed payloads (`400`) and unexpected failures (`500`)

## Example payload

```json
{
  "prompt": "Generate a one-line summary of this project.",
  "provider": "openai",
  "model": "gpt-4o-mini",
  "metadata": {
    "projectId": "abc123",
    "traceId": "hackathon-run-1"
  }
}
```

## Example responses

`400 Bad Request` (validation error)

```json
{
  "error": "Invalid AI request payload.",
  "details": {
    "formErrors": [],
    "fieldErrors": {
      "prompt": ["Prompt is required."]
    }
  }
}
```

`501 Not Implemented` (intentional scaffold fallback)

```json
{
  "ok": true,
  "message": "AI provider not configured. Connect OpenAI or Anthropic to enable completions.",
  "request": {
    "provider": "openai",
    "model": "unset",
    "promptPreview": "Generate a one-line summary of this project."
  }
}
```

## How to connect OpenAI or Anthropic (without committing secrets)

1. Install the provider SDK you choose (`openai` or `@anthropic-ai/sdk`).
2. Add server-only environment variables in `.env` (for local) and Vercel Project Settings (for deploy).
3. Validate any new environment variables in `src/env.ts` with `zod` before use.
4. In `POST /api/ai`, replace the scaffold fallback block with a provider call.
5. Keep API keys server-side only. Do not expose provider keys in `NEXT_PUBLIC_*` variables.

## Suggested env variables

- `OPENAI_API_KEY` for OpenAI
- `ANTHROPIC_API_KEY` for Anthropic
- `SUPABASE_SECRET_KEY` for server-side rate-limit writes (recommended)
- `AI_RATE_LIMIT_WINDOW_SECONDS` (optional, default: `60`)
- `AI_RATE_LIMIT_MAX_REQUESTS` (optional, default: `10`)

Do not commit real values. Commit only placeholder names in documentation.

## Local development key setup

Use `SUPABASE_SECRET_KEY` (server-only) in both hosted and local environments. The AI route requires this key and does not support `SUPABASE_SERVICE_ROLE_KEY`.

## Rate limiting note

The route now uses a Supabase event-log limiter and requires this table:

```sql
create table if not exists public.ai_rate_limit_events (
  id bigint generated by default as identity primary key,
  identifier text not null,
  created_at timestamptz not null default timezone('utc', now())
);

create index if not exists ai_rate_limit_events_identifier_created_at_idx
  on public.ai_rate_limit_events (identifier, created_at desc);
```

`identifier` is derived from client-IP headers (for example `x-real-ip`, `x-forwarded-for`, `cf-connecting-ip`) using the first available value. On each request, the route inserts one event and counts events in the active window to decide `allow` vs `429`.

### Recommended maintenance

To prevent unbounded growth, schedule periodic cleanup of expired events (for example, delete rows older than 24 hours every 10 minutes).

- Use `pg_cron` in Supabase/Postgres when available.
- Otherwise use an external scheduler (for example, Vercel Cron or GitHub Actions) that triggers a protected cleanup path.

Example migration content for `pg_cron`:

```sql
create extension if not exists pg_cron;

create or replace function public.cleanup_ai_rate_limit_events()
returns void
language sql
security definer
as $$
  delete from public.ai_rate_limit_events
  where created_at < now() - interval '24 hours';
$$;

select cron.schedule(
  'cleanup-ai-rate-limit-events',
  '*/10 * * * *',
  $$select public.cleanup_ai_rate_limit_events();$$
);
```

If you need to change cadence/retention, update the cron expression and interval in the function.
